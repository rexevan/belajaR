---
title: "Belajar WebAPI BPS"
author: "Rexevan"
format: html
---

## Pendahuluan

Okay,jadi beberapa minggu lalu saya belajar mengenai WebAPI BPS.
Belajar WebAPI supaya bisa menarik data lebih baik, bukan untuk membuat suatu aplikasi. 
*I'm a data analyst, not a software engineer*.
Lalu, saya menemukan paket `bpsr`, yang bisa dipakai untuk menggunakan WebAPI BPS langsung dari R. Sehingga pembelajaran khusus tentang `bpsr` akan saya taruh di `04-bpsr` sementara untuk `01-api` ini saya pakai untuk belajar membuat fungsi-fungsi yang sekiranya belum ada di paket `bpsr`.

## mengatur variabel WebApi_KEY 

Hal pertama yang perlu di lakukan adalah 


- Kunjungi situs web [PST BPS](pst.bps.go.id), 
- *scroll* ke bawah, sampai ketemu tautan untuk mendapatkan akses Web API BPS, 
- *login* (atau *sign up* jika belum punya akun),
- *Copy* Web API BPS (atau buatkan jika belum punya),
- Jalankan perintah dibawah ini 

```{r}
source("script/00-set-key.R")
bps_set_key()
```
- *Paste* 



## Tabel Dinamis 

Khusus fungsi R untuk mendapatkan tabel dinamis, fungsi-fungsi ini dibuat **sebelum** saya menemukan dengan paket `bpsr`. Untuk pencarian langsung dari R, lebih baik pakai paket `bpsr`.

Fungsi ini dipakai ketika kita ke situs web BPS lalu secara manual pilih **JSON** di tabel dinamis.

```{r}
source("script/03-bikin-fungsi.R")

link <- "https://webapi.bps.go.id/v1/api/list/model/data/lang/ind/domain/5310/var/100/key/WebAPI_KEY"
bps_dt_get(Endpoint_WebAPI = link)
```

Oke, sepertinya berhasil untuk ambil 1 jenis tabel. dsa
Sekarang mari coba untuk beberapa tabel.
Coba ambil angka inflasi kota-kota se Indonesia berdasarkan sub kelompok 

`https://www.bps.go.id/id/statistics-table/2/MjI1MCMy/inflasi-tahunan--y-on-y---2022-100--menurut-kelompok-dan-sub-kelompok-01-makanan--minuman-dan-tembakau.html`

`https://www.bps.go.id/id/statistics-table/2/MjI2MCMy/inflasi-tahunan--y-on-y---2022-100--menurut-kelompok-dan-sub-kelompok-11-perawatan-pribadi-dan-jasa-lainnya.html`

```{r}
library(tidyverse)

get_data_json <- function(get_url) {
    library(tidyverse)
    library(magrittr)
    y <- get_url %$%
        content |>
        rawToChar() |> 
        jsonlite::fromJSON(flatten = TRUE)
    
    return(y)
}


tbl_url <- tibble(a = 2250:2260) |>
    transmute(
        url = paste0("https://webapi.bps.go.id/v1/api/list/model/data/lang/ind/domain/0000/var/", a,"/key/", Sys.getenv("WebAPI_KEY"))
    ) |>
    transmute(
        get_url = map(url, \(x) httr::GET(x))
    ) |>
    mutate(
        get_data = map(get_url, \(x) get_data_json(x))
    )

tbl_url

tbl_data <- tbl_url |> 
    transmute(
        tabular_data = map(get_data, \(x) bps_dt_list2tbl(x))
    ) |>
    unnest(cols = tabular_data)

tbl_data

# write_rds(tbl_data, "output/rds/02-inflasi-y-on-y-per-sub-kelompok-per-kota.rds")

```

## SIMDASI 


## Sensus





